generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  PATROL        // สายตรวจ
  STATION       // ระดับโรงพัก
  PROVINCE      // ระดับจังหวัด
  BUREAU        // ระดับกองบัญชาการ
  HQ            // ระดับ สตช.
}

enum IncidentType {
  PREVENTION    // งานป้องกัน (เหตุปกติ)
  SUPPRESSION   // งานปราบปราม (ผลการจับกุม)
}

enum IncidentCategory {
  TRAFFIC       // ยานพาหนะ
  DRUGS         // ยาเสพติด
  WEAPONS       // อาวุธ
  OTHERS        // อื่นๆ
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskCategory {
  DRUGS         // ยาเสพติด
  WEAPONS       // อาวุธ
  TRAFFIC       // จราจร
  VIOLENT       // ประทุษร้าย
  THEFT         // ลักทรัพย์
  OTHER         // อื่นๆ
}

// ==================== ORGANIZATION HIERARCHY ====================

model Bureau {
  id          String     @id @default(uuid())
  name        String
  code        String     @unique
  provinces   Province[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Province {
  id          String    @id @default(uuid())
  name        String
  code        String    @unique
  bureauId    String
  bureau      Bureau    @relation(fields: [bureauId], references: [id])
  stations    Station[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Station {
  id          String      @id @default(uuid())
  name        String
  code        String      @unique
  address     String?
  latitude    Float?
  longitude   Float?
  provinceId  String
  province    Province    @relation(fields: [provinceId], references: [id])
  users       User[]
  riskZones   RiskZone[]
  pois        PointOfInterest[]  // Layer 2: สถานที่สำคัญ
  patrolPlans PatrolPlan[]       // Layer 4: แผนการตรวจ
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

// ==================== USER ====================

model User {
  id            String         @id @default(uuid())
  username      String         @unique
  password      String
  firstName     String
  lastName      String
  rank          String?        // ยศ
  position      String?        // ตำแหน่ง
  phone         String?
  avatar        String?
  role          UserRole       @default(PATROL)
  stationId     String?
  station       Station?       @relation(fields: [stationId], references: [id])
  isActive      Boolean        @default(true)
  patrolRoutes  PatrolRoute[]
  checkIns      CheckIn[]
  incidents     Incident[]
  // Layer 2 & 4 relations
  createdPOIs           PointOfInterest[]      @relation("POICreator")
  createdPatrolPlans    PatrolPlan[]           @relation("PatrolPlanCreator")
  patrolAssignments     PatrolAssignment[]
  checkpointCompletions CheckpointCompletion[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

// ==================== PATROL TRACKING ====================

model PatrolRoute {
  id          String          @id @default(uuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id])
  planId      String?         // เชื่อมกับแผนการตรวจ (Layer 4)
  plan        PatrolPlan?     @relation(fields: [planId], references: [id])
  startedAt   DateTime        @default(now())
  endedAt     DateTime?
  isActive    Boolean         @default(true)
  complianceRate Float?       // % ที่ทำตามแผน (Layer 5)
  locations   PatrolLocation[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([planId, startedAt])
}

model PatrolLocation {
  id            String      @id @default(uuid())
  patrolRouteId String
  patrolRoute   PatrolRoute @relation(fields: [patrolRouteId], references: [id], onDelete: Cascade)
  latitude      Float
  longitude     Float
  accuracy      Float?
  speed         Float?
  heading       Float?
  timestamp     DateTime    @default(now())

  @@index([patrolRouteId, timestamp(sort: Desc)])
}

model CheckIn {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  riskZoneId  String?
  riskZone    RiskZone? @relation(fields: [riskZoneId], references: [id])
  latitude    Float
  longitude   Float
  note        String?
  photo       String?
  timestamp   DateTime  @default(now())
  createdAt   DateTime  @default(now())

  @@index([userId, timestamp(sort: Desc)])
  @@index([riskZoneId, timestamp(sort: Desc)])
}

// ==================== RISK ZONES ====================

model RiskZone {
  id                  String        @id @default(uuid())
  name                String
  description         String?
  category            RiskCategory  @default(OTHER)  // ประเภทภัย
  latitude            Float
  longitude           Float
  radius              Float         @default(50)  // รัศมีในเมตร
  riskLevel           RiskLevel     @default(MEDIUM)
  requiredCheckIns    Int           @default(4)   // จำนวนครั้งที่ต้องตรวจต่อวัน
  stationId           String
  station             Station       @relation(fields: [stationId], references: [id])
  checkIns            CheckIn[]
  isActive            Boolean       @default(true)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
}

// ==================== INCIDENTS ====================

model Incident {
  id            String           @id @default(uuid())
  type          IncidentType
  userId        String
  user          User             @relation(fields: [userId], references: [id])
  latitude      Float
  longitude     Float
  address       String?
  description   String?
  photos        String[]         // Array of photo URLs
  items         IncidentItem[]
  isResolved    Boolean          @default(false)
  resolvedAt    DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([isResolved, createdAt(sort: Desc)])
}

model IncidentItem {
  id          String            @id @default(uuid())
  incidentId  String
  incident    Incident          @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  category    IncidentCategory
  itemType    String            // เช่น "ยาบ้า", "ปืนไทยประดิษฐ์", "ไม่ติดแผ่นป้ายทะเบียน"
  quantity    Int?              // จำนวน (ถ้ามี)
  unit        String?           // หน่วย เช่น "เม็ด", "กรัม"
  description String?
  photo       String?
  createdAt   DateTime          @default(now())
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id          String    @id @default(uuid())
  title       String
  message     String
  type        String    // incident, alert, info
  data        Json?     // Additional data
  isRead      Boolean   @default(false)
  userId      String?   // Target user (null = broadcast)
  stationId   String?   // Target station
  createdAt   DateTime  @default(now())

  @@index([userId, isRead, createdAt(sort: Desc)])
  @@index([stationId, isRead, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// ==================== POINTS OF INTEREST (Layer 2) ====================

enum POICategory {
  BANK              // ธนาคาร
  GOLD_SHOP         // ร้านทอง
  VIP_RESIDENCE     // บ้าน VIP
  ATM               // ตู้ ATM
  CONVENIENCE_STORE // ร้านสะดวกซื้อ
  GAS_STATION       // ปั๊มน้ำมัน
  SCHOOL            // โรงเรียน
  HOSPITAL          // โรงพยาบาล
  TEMPLE            // วัด
  MARKET            // ตลาด
  MALL              // ห้างสรรพสินค้า
  OTHER             // อื่นๆ
}

enum POIPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model PointOfInterest {
  id            String      @id @default(uuid())
  name          String
  category      POICategory
  priority      POIPriority @default(MEDIUM)
  latitude      Float
  longitude     Float
  address       String?
  description   String?
  photos        String[]
  contactName   String?
  contactPhone  String?
  openHours     String?     // เช่น "08:00-17:00"
  stationId     String
  station       Station     @relation(fields: [stationId], references: [id])
  createdById   String
  createdBy     User        @relation("POICreator", fields: [createdById], references: [id])
  checkpoints   PatrolCheckpoint[]
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([stationId, category])
  @@index([category, isActive])
  @@index([latitude, longitude])
}

// ==================== PATROL PLANS (Layer 4) ====================

enum AssignmentStatus {
  PENDING       // รอดำเนินการ
  IN_PROGRESS   // กำลังดำเนินการ
  COMPLETED     // เสร็จสิ้น
  MISSED        // ไม่ได้ทำ
}

model PatrolPlan {
  id            String          @id @default(uuid())
  name          String
  description   String?
  stationId     String
  station       Station         @relation(fields: [stationId], references: [id])
  createdById   String
  createdBy     User            @relation("PatrolPlanCreator", fields: [createdById], references: [id])
  startTime     DateTime        // เวลาเริ่มต้น
  endTime       DateTime        // เวลาสิ้นสุด
  repeatDaily   Boolean         @default(false)
  checkpoints   PatrolCheckpoint[]
  assignments   PatrolAssignment[]
  routes        PatrolRoute[]   // เชื่อมกับ routes ที่ใช้แผนนี้
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([stationId, isActive])
  @@index([startTime, endTime])
}

model PatrolCheckpoint {
  id            String      @id @default(uuid())
  planId        String
  plan          PatrolPlan  @relation(fields: [planId], references: [id], onDelete: Cascade)
  name          String
  latitude      Float
  longitude     Float
  radius        Float       @default(50)  // รัศมีที่ถือว่าถึงจุด (เมตร)
  sequence      Int         // ลำดับการตรวจ
  expectedTime  DateTime?   // เวลาที่คาดว่าจะถึง
  stayDuration  Int?        // เวลาที่ควรอยู่ (นาที)
  poiId         String?     // เชื่อมกับ POI ถ้ามี
  poi           PointOfInterest? @relation(fields: [poiId], references: [id])
  completions   CheckpointCompletion[]
  createdAt     DateTime    @default(now())

  @@index([planId, sequence])
}

model PatrolAssignment {
  id            String           @id @default(uuid())
  planId        String
  plan          PatrolPlan       @relation(fields: [planId], references: [id], onDelete: Cascade)
  userId        String
  user          User             @relation(fields: [userId], references: [id])
  assignedAt    DateTime         @default(now())
  scheduledDate DateTime         // วันที่ต้องทำ
  status        AssignmentStatus @default(PENDING)
  completedAt   DateTime?
  notes         String?

  @@index([userId, scheduledDate])
  @@index([planId, scheduledDate])
  @@index([status, scheduledDate])
}

model CheckpointCompletion {
  id            String           @id @default(uuid())
  checkpointId  String
  checkpoint    PatrolCheckpoint @relation(fields: [checkpointId], references: [id], onDelete: Cascade)
  userId        String
  user          User             @relation(fields: [userId], references: [id])
  arrivedAt     DateTime
  leftAt        DateTime?
  latitude      Float
  longitude     Float
  photo         String?
  note          String?
  createdAt     DateTime         @default(now())

  @@index([checkpointId, arrivedAt])
  @@index([userId, arrivedAt])
}

